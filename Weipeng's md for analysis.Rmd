---
title: "Temperate Markdown for Report"
author: "Weipeng Li"
date: "2022-12-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(scales)
library(lubridate)
library(glue)
library(ggridges)
library(colorspace)
library(ggpubr)
```



## Global Reported Cases and Deaths of Covid-19

### Data Cleaning and Transformation

To analyze the global spread of Covid-19, it's helpful to observe the reported cases and deaths as a three-year time series from early 2020 to late 2020. As the data is collected from the report of different countries seperately, we first sum them up to obtain the global reported data by day. As the data yields weekly cyclic patterns, which is probabily raised from the delay in weekend data collection of WHO, we build another dataframe by grouping the reported date by week. We believe this weekly reported dataframe may bring clearer insights of the data.


```{r}
who_daily <- read.csv("WHO-COVID-19-global-data.csv")
# summarize the daily reported data of all the countries
world_daily <- who_daily %>%
  group_by(Date_reported) %>%
  mutate(world_new_cases = sum(New_cases)) %>%
  mutate(world_new_deaths = sum(New_deaths)) %>%
  select(c(Date_reported, world_new_cases, world_new_deaths)) %>%
  distinct()  %>%
  mutate(Date_reported = as.Date(Date_reported))

# summarize the weekly reported data to remove cyclic patterns
world_weekly <- world_daily %>%
  mutate(week = as.numeric(floor((Date_reported-as.Date('2020-01-03'))/7))) %>%
  group_by(week) %>%
  mutate(weekly_new_cases = sum(world_new_cases)) %>%
  mutate(weekly_new_deaths = sum(world_new_deaths)) %>%
  mutate(date_reported = as.Date(as.Date('2020-01-03')+week*7)) %>%
  select(date_reported,weekly_new_cases,weekly_new_deaths,week) %>%
  ungroup() %>%
  distinct()

head(world_daily)
head(world_weekly)
```
### Results

Covid-19 started at the beginning of 2020, and spread quickly accross the world. To analyze the overall spread pattern of the pademic, we analyze the global cases and deaths data as a time series. By plotting the time series by day, we observed a strong cyclic pattern, making the data very noisy. This is because of the delay of data update during weekends of the original dataset. To remove the cyclic pattern, it's better to use the weekly time series.

From the two weekly time series, we observed the following patterns.

* The first spike of reported deaths appeared in April 2020, with no spike in reported cases at the same time. This refer to the early spread in China. The low cases and high deaths also indicate the high fatality rate of the virus at the beginning.

* In January 2021, both the reported cases and reported deaths experience a relatively strong spike. During this time, the has pandemic spreaded worldwide, and contries in Europe and America are experiencing a high infection rate of Covid-19.

* The reported cases and deaths began decreasing slowly with vaccination being available since December 2020.

* The most outstanding spike of reported cases appeared in January 2022, with over 20 million weekly new cases around the world. This was over four times of that in January 2021. This was exactly the time when Omicron variant spread drastically accross the world. However, the report deaths did not increase that much at the mean time, from which we could conclude that Omicron spreads more easily than earlier variants, but causes less severe illness and death in general.


```{r}
# global new cases by day
p1 <- ggplot(world_daily,aes(Date_reported,world_new_cases))+
  geom_area(color='red',fill='pink',alpha=0.5)+
  scale_x_date(breaks = function(x) seq.Date(from = min(x), to = max(x), by = "4 months"),
               labels = function(x) paste(lubridate::year(x),'-',lubridate::month(x), sep=''))+
  xlab('Date Reported')+
  ylab('New Cases')+
  ggtitle('Daily New Reported Cases')+
  theme_light()

# global new cases by week
p2 <- ggplot(world_weekly, aes(date_reported,weekly_new_cases))+
  geom_area(color='red',fill='pink',alpha=0.5)+
  scale_x_date(breaks = function(x) seq.Date(from = min(x), to = max(x), by = "4 months"),
               labels = function(x) paste(lubridate::year(x),'-',lubridate::month(x), sep=''))+
  xlab('Date Reported')+
  ylab('New Cases')+
  ggtitle('Weekly New Reported Cases')+
  theme_light()

# global new deaths by day
p3 <- ggplot(world_daily, aes(Date_reported,world_new_deaths))+
  geom_area(color='black',fill='grey',alpha=0.5)+
  scale_x_date(breaks = function(x) seq.Date(from = min(x), to = max(x), by = "4 months"),
               labels = function(x) paste(lubridate::year(x),'-',lubridate::month(x), sep=''))+
  xlab('Date Reported')+
  ylab('Deaths')+
  ggtitle('Daily Deaths')+
  theme_light()

# global new deaths by week
p4 <- ggplot(world_weekly, aes(date_reported,weekly_new_deaths))+
  geom_area(color='black',fill='grey',alpha=0.5)+
  scale_x_date(breaks = function(x) seq.Date(from = min(x), to = max(x), by = "4 months"),
               labels = function(x) paste(lubridate::year(x),'-',lubridate::month(x), sep=''))+
  xlab('Date Reported')+
  ylab('Deaths')+
  ggtitle('Weekly Deaths')+
  theme_light()

p <- ggarrange(p1, p3, p2, p4,ncol = 2,nrow=2)
p
```

## US Vaccination Comparing to Global Data

### Data Cleaning and Transformation

The WHO vaccination data provides detailed vaccination data divided by countries. For each country, it gives the total vaccinations, the vaccinated rate, fully vaccinated rate as well as the main type of vaccines the country uses. In our analysis, we only care about the vaccinated rate and fully vaccinated rate of different countries. Another issue of the data is missing values and outliers. There's no fully vaccinated rate for Guernsey, and the fully vaccinated rate of Eritrea, Brunei Darussalam, Gibraltar, Palau and Tokelau are more than 100%. So we drop these six rows in the dataset. 

```{r}
world_vac_df <- read.csv('vaccination-data.csv')
world_vac <- world_vac_df %>%
  select(COUNTRY,PERSONS_FULLY_VACCINATED_PER100) %>%
  rename(country=COUNTRY, fully_vaccinated_rate = PERSONS_FULLY_VACCINATED_PER100)

# check and remove missing values and outliers
na_index <- c(which(is.na(world_vac$fully_vaccinated_rate)),which(world_vac$fully_vaccinated_rate<=0))
outlier_index <- which(world_vac$fully_vaccinated_rate>100)
world_vac[c(na_index,outlier_index),]
world_vac <- world_vac[-c(na_index,outlier_index),]
```

### Results

We draw a boxplot of the fully vaccinated rate of different countries across the world. The median of global fully vaccinated rate is 61.165, while the US fully vaccinated rate is 67.989, which is between the median and third quantile of the global data.


```{r}
ggplot(world_vac, aes(x=fully_vaccinated_rate)) +
  geom_boxplot()+
  geom_segment(x=67.789,xend=67.789,y=-0.37,yend=0.37,color='red',linetype='dotted')+
  geom_text(aes(x=73, label="\nUnited States: 67.989", y=0.3), color="red",size=3)+
  ggtitle('US Fully Vaccinated Rate Comparing to Global Data') +
  xlab('Fully Vaccinated Rate')+
  ylab('')+
  theme(legend.title=element_blank())+
  coord_flip()+
  theme_light()
```

### Vaccination State in US Population

### Data Cleaning and Transformation

We extract the US vaccination data from the WHO global vaccination dataset. As we want to draw a stacked bar chart of the US population with different vaccinated status, we use the tidy form of the data. We also change the vaccinated rate a little bit for better graph view, e.g. the vaccinated status only refers to those who haven't finished the vaccination series, and the fully_vaccinated status only referes to those who haven't take the booster.

```{r}
us_vac <- world_vac_df %>%
  filter(COUNTRY=='United States of America') %>%
  select(PERSONS_VACCINATED_1PLUS_DOSE_PER100,
         PERSONS_FULLY_VACCINATED_PER100,
         PERSONS_BOOSTER_ADD_DOSE_PER100) %>%
  rename(vaccinated=PERSONS_VACCINATED_1PLUS_DOSE_PER100,
         fully_vaccinated=PERSONS_FULLY_VACCINATED_PER100,
         boosted=PERSONS_BOOSTER_ADD_DOSE_PER100) %>%
  mutate(not_vaccinated=100-vaccinated) %>%
  mutate(vaccinated=vaccinated-fully_vaccinated) %>%
  mutate(fully_vaccinated=fully_vaccinated-boosted) %>%
  mutate(country='United States of America') %>%
  pivot_longer(!country)
us_vac$name <- factor(us_vac$name, levels=c('boosted','fully_vaccinated','vaccinated','not_vaccinated'))
us_vac
```


### Result

From the stacked bar chart of the US vaccination status, we observe that 68% of the US population has been fully vaccinated, among which 33.7% of the population has taken the booster. However, there are still 20.3% of the population who have not taken any vaccine.

```{r}
us_vac$country <- rep('',4)
ggplot(us_vac, aes(country,value,fill=fct_rev(name)))+
  geom_col()+
  geom_text(aes(x=1, label="33.7%", y=26), color="black",size=4)+
  geom_text(aes(x=1, label="34.3%", y=60), color="black",size=4)+
  geom_text(aes(x=1, label="11.7%", y=74), color="black",size=4)+
  geom_text(aes(x=1, label="20.3%", y=94), color="black",size=4)+
  xlab('')+
  ylab('Proportion')+
  ggtitle('Vaccination State of US Population')+
  scale_fill_discrete_sequential(palette = "Terrain2")+
  theme(plot.margin=unit(rep(2,8),'cm'))+
  theme_light()+
  theme(legend.title=element_blank())+
  coord_flip()
```


## Vaccination Rate by Age

### Data Source

### Data Cleaning and Transformation

For the vaccination rate of different age groups, we use the data from CDC (Centers of Disease Control and Prevention). It provides vaccinated and fully vaccinated rate by age. As each age group yields several observations from different date, we use the data from the latest update as the vaccinated rate is a cumulative variable. Besides, there are no reported data from children less than 5 years old, as they are too young to get vaccinated, so we only focus on 6 age groups: '5 - 1','12 - 17','18 - 24','25 - 49', '50 - 64', and '65+'.

```{r}
vac_age_df <- read.csv('COVID-19_Vaccination_and_Case_Trends_by_Age_Group__United_States.csv')
vac_age <- vac_age_df %>%
  select(Date.Administered,AgeGroupVacc,Series_Complete_Pop_pct_agegroup,
         X7.day_avg_group_cases_per_100k,Administered_Dose1_pct_agegroup) %>%
  rename(date=Date.Administered,age=AgeGroupVacc,
         fully_vaccinated_rate=Series_Complete_Pop_pct_agegroup,
         vaccinated_rate=Administered_Dose1_pct_agegroup,
         case_rate=X7.day_avg_group_cases_per_100k)%>%
  filter(date==max(date)) %>%
  mutate(vaccinated_rate=percent(vaccinated_rate)) %>%
  mutate(fully_vaccinated_rate=percent(fully_vaccinated_rate)) %>%
  mutate(case_rate=percent(case_rate/100000)) %>%
  filter(age %in% c('5 - 11 Years','12 - 17 Years','18 - 24 Years','25 - 49 Years',
                    '50 - 64 Years', '65+ Years'))
vac_age_long <- pivot_longer(vac_age[,c(2,3,5)],cols=!age)
vac_age_long
```


### Result

From the grouped bar chart below, both the vaccinated and fully vaccinated rate grow with the age groups. People aged over 65 have the highest fully vaccinated rate of 88.6% and vaccinated rate of 95%. This is reasonable because the old people are more prone to be infected by the virus, so they are more likely to take the complete series of vaccines. Children less than 12 years are too young so their parents may worry about the side effects of the vaccine, so they have a lowest fully vaccinated rate of 16.7% and a vaccinated rate of 25.6%.

```{r}
ggplot(vac_age_long, aes(fct_relevel(age,'5 - 11 Years'),value,fill=name)) +
  geom_col(position=position_dodge(),alpha=0.6) +
  geom_text(aes(label=value), position=position_dodge(width=0.9), vjust=-0.3,size=3)+
  xlab('Ages')+
  ylab('Vaccinated Rate') +
  ggtitle('Vaccinatied and Reported Case Rate by Age')+
  scale_fill_discrete(name='')+ 
  theme_light()
```









